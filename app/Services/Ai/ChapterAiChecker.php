<?php

namespace App\Services\Ai;

use OpenAI\Laravel\Facades\OpenAI;


class ChapterAiChecker
{
    public function check(string $text): array
    {
        // return [
        //     'ok' => false,
        //     'errors' => [
        //         [
        //             'type' => 'spelling',
        //             'message' => 'Найдено слово с ошибкой',
        //             'fragment' => 'програмирование',
        //         ],
        //     ],
        //     'summary' => 'Найдены орфографические ошибки',
        // ];
        try {
            $content = <<<PROMPT
Ты выступаешь как аккуратный редактор текста.

Твоя задача — найти ТОЛЬКО:
1. Реальные орфографические ошибки
2. Явные технические ошибки оформления текста

ВАЖНО:
- НЕ анализируй стиль текста
- НЕ оценивай содержание документов
- НЕ проверяй юридическую или нормативную корректность
- НЕ выдумывай ошибки
- НЕ давай рекомендаций по улучшению формулировок

Строгое определение орфографической ошибки:
- неверное написание слова
- пропущенные или лишние буквы внутри слова
- явно бессмысленные наборы букв
  (например: «фывфы», «asdf», «qwer»)

Строгое определение технической ошибки оформления:
- отсутствие обозначения «г.» после даты вида ДД.ММ.ГГГГ
- использование «No» вместо символа «№»
- лишние или ошибочные символы внутри кодов и номеров
  (например: двойные точки, лишние дефисы)
- очевидные опечатки в числовых диапазонах и кодах

НЕ считать ошибками:
- оформление ссылок как нормативных документов
- использование «гг.» для диапазонов лет (например: 2022–2027 гг.)
- тип кавычек, пробелы, тире
- различия оформления, не влияющие на читаемость

Сообщай ТОЛЬКО о реальных ошибках.
Если есть сомнение — СЧИТАЙ, ЧТО ОШИБКИ НЕТ.

Ответь СТРОГО в JSON следующего формата:
{
  "ok": boolean,
  "errors": [
    {
      "type": "spelling | formatting",
      "message": string,
      "fragment": string
    }
  ],
  "summary": string
}

Текст главы:
$text
PROMPT;

            // gpt-5-mini-2025-08-07

            $response = OpenAI::chat()->create([
                'model' => 'gpt-4.1-mini',
                'temperature' => 0,
                'messages' => [
                    [
                        'role' => 'system',
                        'content' =>
                        'Ты научный редактор. Отвечай строго JSON.'
                    ],
                    [
                        'role' => 'user',
                        'content' => $content
                    ]
                ],
            ]);

            return json_decode(
                $response->choices[0]->message->content,
                true
            );
        } catch (\Throwable $e) {
            return [
                'ok' => false,
                'errors' => [
                    [
                        'type' => 'system',
                        'message' => 'Ошибка AI: ' . $e->getMessage(),
                        'fragment' => '',
                    ],
                ],
                'summary' => 'Ошибка проверки',
            ];
        }
    }
}
